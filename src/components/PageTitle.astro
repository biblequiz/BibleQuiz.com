---
const {
    title,
    description,
    eventId,
    eventType,
    eventDates,
    eventScope,
    eventScopeLabel,
    eventLocation,
    eventIsLoaded,
    showCurrentEvents,
    hidePageTitle,
    hidePageTitleOnPrint,
} = Astro.locals.starlightRoute.entry.data;

import ExcelExportButton from "./scores/ExcelExportButton.astro";
import PrintDialogButton from "./scores/PrintDialogButton.astro";
import ToggleFavoritesOnlyButton from "./scores/ToggleFavoritesOnlyButton";
import EventScopeBadge from "./EventScopeBadge";
import { getAstroRootSourcePath } from "utils/FileSystem";
import { fileExists } from "utils/FileSystem";
import { getSeasons } from "utils/Seasons";

const rootSourcePath = await getAstroRootSourcePath(import.meta.url);

let currentSeasonLink: string | undefined = undefined;
if (eventType && showCurrentEvents) {
    const rootSeasonsForType = `${rootSourcePath}/content/docs/${eventType}/Seasons`;

    const seasons = await getSeasons(import.meta.url);
    if (
        await fileExists(`${rootSeasonsForType}/${seasons[1]}/results.mdx`)
    ) {
        currentSeasonLink = `/${eventType}/seasons/${seasons[1]}/results/`;
    } else {
        currentSeasonLink = `/${eventType}/seasons/${seasons[1]}/`;
    }
}

let resolvedEventType = eventType;
if (!resolvedEventType) {
    const path = new URL(Astro.request.url).pathname;
    if (path.startsWith("/jbq/")) {
        resolvedEventType = "jbq";
    } else if (path.startsWith("/tbq/")) {
        resolvedEventType = "tbq";
    }
}
---

{hidePageTitle && <div id="_top_hide_parent_id" />}
{
    !hidePageTitle && (
        <h1
            id="_top"
            class={`page-title ${hidePageTitleOnPrint ? "hide-on-print" : ""}`}
        >
            {resolvedEventType && (
                <div class="align-top shrink-0">
                    <img
                        src={`/assets/logos/${resolvedEventType}/${resolvedEventType}-logo.png`}
                        alt={resolvedEventType}
                        width="72"
                        height="72"
                        class="event-icon"
                    />
                </div>
            )}
            <span class="event-title-text">
                {title}
                {description && <p class="italic text-sm">{description}</p>}
                {showCurrentEvents && (
                    <a
                        href={`/current-events?type=${resolvedEventType}`}
                        class="btn btn-primary cursor-pointer hide-on-print whitespace-nowrap"
                    >
                        Current Events
                    </a>
                )}
            </span>
            {eventType && eventId && (
                <span>
                    <PrintDialogButton isLoaded={eventIsLoaded ?? false} />
                    <ExcelExportButton isLoaded={eventIsLoaded ?? false} />
                    <ToggleFavoritesOnlyButton
                        isLoaded={eventIsLoaded ?? false}
                        client:only="react"
                    />
                </span>
            )}
        </h1>
    )
}
{
    !hidePageTitle && (eventScope || eventDates || eventLocation) && (
        <div class={`mt-0 ${hidePageTitleOnPrint ? "hide-on-print" : ""}`}>
            {eventScope && (
                <EventScopeBadge scope={eventScope} label={eventScopeLabel} />
            )}
            {(eventDates || eventLocation) && (
                <i>
                    {eventDates} @ {eventLocation}
                </i>
            )}
        </div>
    )
}

<script>
    const hideParentElement = document.getElementById("_top_hide_parent_id");
    if (hideParentElement) {
        const contentPanel = hideParentElement.closest(
            "div.content-panel",
        ) as HTMLDivElement;
        if (contentPanel) {
            contentPanel.style.display = "none";
        }
    }

    import { PrintDialogModalId } from "./scores/PrintDialogContent";
    const button: HTMLElement = document.getElementById(
        `${PrintDialogModalId}-button`,
    )!;

    if (button) {
        const title = button.closest("h1.page-title");
        if (title && title.classList.contains("hide-on-print")) {
            const ancestor = title.closest("div.content-panel");
            if (ancestor) {
                ancestor.classList.add("hide-on-print");
            }
        }
    }
</script>
