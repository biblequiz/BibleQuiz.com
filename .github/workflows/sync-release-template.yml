name: sync-release-template
on:
  workflow_call:
    inputs:
      tag_name:
        description: 'Optional tag name for the release'
        required: false
        type: string
      product_name:
        description: 'Product name for BibleQuiz.com'
        required: true
        type: string
      commit_changes:
        description: 'Whether to commit and push changes to the target repository'
        required: false
        type: boolean
        default: true
    secrets:
      BOT_APP_ID:
        required: true
      BOT_APP_PRIVATE_KEY:
        required: true
jobs:
  sync-release:
    runs-on: ubuntu-latest
    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}
          owner: biblequiz
          repositories: "BibleQuiz.com"

      - name: Checkout BibleQuiz.com
        uses: actions/checkout@v4
        with:
          repository: biblequiz/BibleQuiz.com
          token: ${{ steps.generate_token.outputs.token }}
          path: BibleQuiz.com
      
      - name: Display Release data
        id: process
        run: |
          echo "Release action: ${{ github.event.action }}"
          echo "Release tag: ${{ github.event.release.tag_name }}"
          echo "Release name: ${{ github.event.release.name }}"
          
      - name: Process release
        run: |
          cd BibleQuiz.com

          # Parse the repo name.
          FULL_REPO_NAME="${{ github.repository }}"
          REPO_NAME="${FULL_REPO_NAME##*/}"
          
          # Get the tag name to use as filename
          TAG_NAME="${{ github.event.release.tag_name || inputs.tag_name }}"

          # Sanitize tag name for use as filename (replace / with -)
          FILENAME=$(echo "$TAG_NAME" | sed 's/\//-/g')
          DIRECTORY="src/releases/${{ inputs.product_name }}/${REPO_NAME}"
          FULLPATH="${DIRECTORY}/${FILENAME}.json"
          
          ACTION="${{ github.event.action || 'released' }}"
          if [[ -z "$FILENAME" ]]; then
            echo "No File Name detected"
          elif [[ "$ACTION" == "deleted" || "$ACTION" == "unpublished" ]]; then
            # Delete the file if it exists
            if [ -f "$FULLPATH" ]; then
              rm "$FULLPATH"
              echo "Deleted $FULLPATH"
            else
              echo "File $FULLPATH does not exist"
            fi
          else
            # Create releases directory if it doesn't exist
            mkdir -p $DIRECTORY
            
            # Fetch the latest release data from API to ensure we have assets
            RELEASE_DATA=$(curl -s -H "Authorization: token ${{ steps.generate_token.outputs.token }}" \
              "https://api.github.com/repos/${FULL_REPO_NAME}/releases/tags/${TAG_NAME}")
            
            # Write the entire release object to JSON file
            echo "$RELEASE_DATA" > "$FULLPATH"
            echo "Created/updated ${FULLPATH}"

            echo "========== File contents =========="
            cat "$FULLPATH"
            echo "==================================="
          fi
      
      - name: Commit to BibleQuiz.com
        if: ${{ inputs.commit_changes != false }}
        run: |
          cd BibleQuiz.com
          git config user.name "bible-quiz-bot[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          
          ACTION="${{ github.event.action || 'manual' }}"
          TAG_NAME="${{ github.event.release.tag_name || inputs.tag_name }}"
          
          if [[ "$ACTION" == "deleted" || "$ACTION" == "unpublished" ]]; then
            git commit -m "Remove ${{ inputs.product_name }} Release: $TAG_NAME ($ACTION)" || echo "No changes to commit"
          else
            git commit -m "Add/Update ${{ inputs.product_name }} Release: $TAG_NAME ($ACTION)" || echo "No changes to commit"
          fi
          
          git push
